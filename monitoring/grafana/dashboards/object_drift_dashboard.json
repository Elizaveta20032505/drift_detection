{
  "annotations": {
    "list": [
      {"builtIn": 1, "datasource": {"type": "grafana", "uid": "-- Grafana --"}, "enable": true, "hide": true, "iconColor": "rgba(0, 211, 255, 1)", "name": "Annotations & Alerts", "type": "dashboard"}
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "panels": [
    {
      "datasource": {"type": "prometheus", "uid": "Prometheus"},
      "description": "PSI: сравнение распределений (RGB-гистограммы baseline vs текущее окно).",
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 0.2}]}
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
      "id": 1,
      "options": {"legend": {"displayMode": "list", "placement": "bottom"}},
      "targets": [
        {"expr": "sum(rate(object_drift_psi_sum[5m])) / sum(rate(object_drift_psi_count[5m]))", "legendFormat": "mean", "refId": "A"}
      ],
      "title": "PSI (порог дрейфа > 0.2)",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "prometheus", "uid": "Prometheus"},
      "description": "KL divergence по CNN-признакам (ResNet).",
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 1}]}
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
      "id": 2,
      "options": {"legend": {"displayMode": "list", "placement": "bottom"}},
      "targets": [
        {"expr": "sum(rate(object_drift_kl_divergence_sum[5m])) / sum(rate(object_drift_kl_divergence_count[5m]))", "legendFormat": "mean", "refId": "A"}
      ],
      "title": "KL divergence (порог дрейфа > 1.0)",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "prometheus", "uid": "Prometheus"},
      "description": "KS: статистика и p-value по распределению яркости. Дрейф при p-value < 0.05.",
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "orange", "value": 0.3}, {"color": "red", "value": 0.5}]}
        },
        "overrides": [
          {
            "matcher": {"id": "byName", "options": "p-value mean"},
            "properties": [
              {"id": "unit", "value": "none"},
              {"id": "custom.axisPlacement", "value": "right"},
              {"id": "thresholds", "value": {"mode": "absolute", "steps": [{"color": "red", "value": null}, {"color": "green", "value": 0.05}]}}
            ]
          }
        ]
      },
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
      "id": 3,
      "options": {"legend": {"displayMode": "list", "placement": "bottom"}},
      "targets": [
        {"expr": "sum(rate(object_drift_ks_statistic_sum[5m])) / sum(rate(object_drift_ks_statistic_count[5m]))", "legendFormat": "KS statistic mean", "refId": "A"},
        {"expr": "sum(rate(object_drift_ks_pvalue_sum[5m])) / sum(rate(object_drift_ks_pvalue_count[5m]))", "legendFormat": "p-value mean", "refId": "B"}
      ],
      "title": "KS statistic и p-value (порог дрейфа p-value < 0.05)",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "prometheus", "uid": "Prometheus"},
      "description": "Wasserstein distance между распределениями яркости.",
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 30}]}
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
      "id": 7,
      "options": {"legend": {"displayMode": "list", "placement": "bottom"}},
      "targets": [
        {"expr": "sum(rate(object_drift_wasserstein_sum[5m])) / sum(rate(object_drift_wasserstein_count[5m]))", "legendFormat": "mean", "refId": "A"}
      ],
      "title": "Wasserstein distance (порог дрейфа > 30)",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "prometheus", "uid": "Prometheus"},
      "description": "Jensen-Shannon divergence (симметричная).",
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 0.3}]}
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
      "id": 8,
      "options": {"legend": {"displayMode": "list", "placement": "bottom"}},
      "targets": [
        {"expr": "sum(rate(object_drift_js_divergence_sum[5m])) / sum(rate(object_drift_js_divergence_count[5m]))", "legendFormat": "mean", "refId": "A"}
      ],
      "title": "Jensen-Shannon divergence (порог дрейфа > 0.3)",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "prometheus", "uid": "Prometheus"},
      "description": "Взвешенная сумма нормализованных метрик.",
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "max": 1,
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 0.3}, {"color": "red", "value": 0.5}]}
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
      "id": 9,
      "options": {"legend": {"displayMode": "list", "placement": "bottom"}},
      "targets": [
        {"expr": "sum(rate(object_drift_aggregate_score_sum[5m])) / sum(rate(object_drift_aggregate_score_count[5m]))", "legendFormat": "mean", "refId": "A"}
      ],
      "title": "Агрегированная метрика дрейфа (порог внимания > 0.5)",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "prometheus", "uid": "Prometheus"},
      "description": "Секунда текущего видео. При запуске нового видео обновляется одна серия — график по сути начинается заново.",
      "fieldConfig": {"defaults": {"unit": "s"}, "overrides": []},
      "gridPos": {"h": 6, "w": 12, "x": 0, "y": 24},
      "id": 10,
      "options": {"legend": {"displayMode": "list", "placement": "bottom"}},
      "targets": [{"expr": "object_drift_video_seconds", "legendFormat": "сек видео", "refId": "A"}],
      "title": "Время видео (сек)",
      "type": "timeseries"
    },
    {
      "datasource": {"type": "prometheus", "uid": "Prometheus"},
      "description": "Алерты: 1 = сработал. drift — общая детекция дрейфа; Page-Hinkley — тест по последовательности метрик.",
      "fieldConfig": {"defaults": {"unit": "none", "min": 0, "max": 1}, "overrides": []},
      "gridPos": {"h": 6, "w": 12, "x": 12, "y": 24},
      "id": 11,
      "options": {"legend": {"displayMode": "list", "placement": "bottom"}},
      "targets": [
        {"expr": "object_drift_alert", "legendFormat": "drift", "refId": "A"},
        {"expr": "object_drift_ph_alert", "legendFormat": "Page-Hinkley", "refId": "B"}
      ],
      "title": "Алерты дрейфа",
      "type": "timeseries"
    }
  ],
  "refresh": "10s",
  "schemaVersion": 39,
  "style": "dark",
  "tags": ["drift", "object"],
  "templating": {"list": []},
  "time": {"from": "now-30m", "to": "now"},
  "timepicker": {},
  "timezone": "browser",
  "title": "Object Drift Monitoring",
  "uid": "object-drift",
  "version": 3
}
